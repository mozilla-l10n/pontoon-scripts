"""
This script takes a CSV file generated by pretranslation_evaluation.py,
and adds the TER score as an additional column.

The output is saved as a new file, with added `_TER` at the end.

This script requires the sacreblue module.
"""

from pathlib import Path
from sacrebleu.metrics import TER
import argparse
import csv
import os


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "csv_file",
        help="Path to CSV file",
    )
    args = parser.parse_args()

    csv_orig = os.path.realpath(args.csv_file)
    csv_new = os.path.join(os.path.dirname(csv_orig), f"{Path(csv_orig).stem}_TER.csv")

    ter = TER()
    with open(csv_orig) as f:
        reader = csv.DictReader(f)
        new_content = []
        for row in reader:
            new_row = row
            score = ter.sentence_score(row["Rejected"], [row["Approved"]])
            new_row["TER Score"] = float(score.format(score_only=True))
            new_content.append(new_row)

    with open(csv_new, "w") as f:
        writer = csv.DictWriter(
            f,
            list(new_content[0].keys()),
            quoting=csv.QUOTE_NONNUMERIC,
        )
        writer.writeheader()
        for row in new_content:
            writer.writerow(row)


if __name__ == "__main__":
    main()
